import streamlit as st
import requests
import json

API_URL = "http://127.0.0.1:8005/predict"

st.set_page_config(page_title="Diamonds Price Predictor", page_icon="üíé", layout="centered")

st.title("üíé Diamonds Price Predictor")
st.markdown(
    """
    This dashboard connects to a **FastAPI** service that uses the latest **XGBoost** model from the **MLflow Registry**.
    """
)
st.divider()

col1, col2 = st.columns(2)

with col1:
    st.subheader("üì¶ Physical Features")
    carat = st.slider("Carat (Size)", 0.2, 5.0, 1.0, 0.01)
    x = st.number_input("Length (x) mm", 0.0, 10.0, 5.0)
    y = st.number_input("Width (h) mm", 0.0, 10.0, 5.0)
    z = st.number_input("Depth (z) mm", 0.0, 10.0, 3.0)

with col2:
    st.subheader("üíé Quality Features")
    cut = st.selectbox("Cut", ['Fair', 'Good', 'Very Good', 'Premium', 'Ideal'], index=4)
    color = st.selectbox("Color", ['J', 'I', 'H', 'G', 'F', 'E', 'D'], index=6)
    clarity = st.selectbox("Clarity", ['I1', 'SI2', 'SI1', 'VS2', 'VS1', 'VVS2', 'VVS1', 'IF'], index=4)

    st.write("---")
    depth = st.slider("Depth Percentage (Depth %)", 43.0, 79.0, 61.5)
    table = st.slider("Table Width (Table)", 43.0, 95.0, 55.0)

st.divider()

if st.button("üí∞ Guess the Price", type="primary", use_container_width=True):

    payload = {
        "carat": carat,
        "cut": cut,
        "color": color,
        "clarity": clarity,
        "depth": depth,
        "table": table,
        "x": x,
        "y": y,
        "z": z
    }

    with st.spinner("Asking the FastAPI Engine..."):
        try:
            response = requests.post(API_URL, json=payload)

            if response.status_code == 200:
                result = response.json()
                price = result["predicted_price"]
                version = result["model_version"]

                st.success(f"Predicted Price: **${price:,.2f}**")

                st.info(f"‚ÑπÔ∏è This prediction was generated by the **Version {version}** model from the MLflow Registry.")
            else:
                st.error(f"API Error: {response.text}")

        except Exception as e:
            st.error(f"Couldn't connect to API! Is FastAPI running in Terminal 2?\n\nError: {e}")